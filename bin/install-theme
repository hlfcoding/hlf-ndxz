#!/usr/bin/env bash

root_dir=$(pwd)
config_dir="$root_dir/config"
src_dir="$root_dir/src"
theme_dir="$root_dir/theme"
var_dir="$root_dir/var"
web_dir="$root_dir/web"

set -euo pipefail
trap 'echo -e "\nFailed to install theme!\n"' ERR

cd "$theme_dir"
echo -e "\nTheme name? Available themes:\n"
# shellcheck disable=SC2012
ls -d ./*/ | cut -d '/' -f 2
echo; read -p 'name: ' -r name
theme_dir="$theme_dir/$name"
current_name=$(cat "$var_dir/st-theme")

echo -e "\nInstalling theme '$name'..."

# Switch to and from another theme to re-run theme setup.
if [[ -x "$theme_dir/bin/setup" && $name != "$current_name" ]]; then
  cd "$root_dir"
  "$theme_dir/bin/setup"
fi

cd "$theme_dir"
cp -f 'src/ThemeServiceProvider.php' "$src_dir/Silexhibit/"
echo -e "\nInstalled theme PHP!"

rm -rf "$src_dir/mustache/theme/"*.mustache
cp -rf src/mustache/*.mustache "$src_dir/mustache/theme/"
echo -e "Installed theme templates!"

rm -rf "$config_dir/theme/"*.php
if [[ -d config ]]; then
  cp -rf config/*.php "$config_dir/theme/"
  echo -e "Installed theme configurations!"
fi

function cp_any_assets {
  local from_dir=$1
  local to_dir=$2
  rm -rf "$to_dir"*.{css,js,ico,jpg,png,ttf,woff}
  if [[ ! -d "$from_dir" ]]; then
    return
  fi
  for f in "$from_dir"*.{css,js,ico,jpg,png,ttf,woff}; do
    if [[ -f "$f" ]]; then
      cp -f "$f" "$to_dir"
    fi
  done
}
cp_any_assets web/ "$web_dir/theme/"
cp_any_assets web/lib/ "$web_dir/lib/theme/"
cp_any_assets web/media/ "$web_dir/media/theme/"
echo -e "Installed theme assets!"

echo "$name" > "$var_dir/st-theme"
echo -e "\nInstalled theme '$name'!\n"

cd "$root_dir"
