#!/usr/bin/env bash

if [[ ! -d src/Silexhibit ]]; then echo -e "\nMust run in project root!\n"; exit 1; fi
set -euo pipefail
root_dir=$(pwd)
function finish {
  if [[ "$?" -gt 0 ]]; then echo -e "\n${RED}Failed to install theme!${NC}\n"; fi
  cd "$root_dir"
}
trap finish EXIT
# shellcheck disable=SC1091
source bin/rc; echo

theme=''; hard=false
for i in "$@"; do case $i in
  -h|--help) cat <<EOD
Cleans theme/ folders and copies files from --theme (-t).
Theme bin/setup is only run as needed or if --hard install.
Must run in project root.
EOD
  echo; exit 0;;
  --hard) hard=true; shift;;
  -t=*|--theme=*) theme="${i#*=}"; shift;;
  *) echo -e "${RED}Unknown option: ${i%=*}${NC}\n"; exit 1;;
esac; done
if [[ -z $theme ]]; then echo -e "${RED}Missing --theme!${NC}\n"; exit 1; fi

echo -e "Installing theme..."

current_theme=$(cat "$root_dir/var/st-theme")
setup="$root_dir/theme/$theme/bin/setup"
if [[ -x "$setup" && ($theme != "$current_theme" || "$hard" == true) ]]; then "$setup"
else echo; fi

cd "$root_dir/theme/$theme"

cp -f src/ThemeServiceProvider.php "$root_dir/src/Silexhibit/"
echo -e "${GREEN}Installed theme PHP!${NC}"

rm -rf "$root_dir/src/mustache/theme/"*.mustache
cp -rf src/mustache/*.mustache "$root_dir/src/mustache/theme/"
echo -e "${GREEN}Installed theme templates!${NC}"

rm -rf "$root_dir/config/theme/"*.php
if [[ -d config ]]; then
  cp -rf config/*.php "$root_dir/config/theme/"
  echo -e "${GREEN}Installed theme configurations!${NC}"
fi

function cp_any_assets {
  local from_dir=$1; local to_dir=$2
  rm -rf "$to_dir"*.{css,js,ico,jpg,png,ttf,woff}
  if [[ ! -d "$from_dir" ]]; then return; fi
  for f in "$from_dir"*.{css,js,ico,jpg,png,ttf,woff}; do
    if [[ -f "$f" ]]; then cp -f "$f" "$to_dir"; fi
  done
}
cp_any_assets web/ "$root_dir/web/theme/"
cp_any_assets web/lib/ "$root_dir/web/lib/theme/"
cp_any_assets web/media/ "$root_dir/web/media/theme/"
echo -e "${GREEN}Installed theme assets!${NC}"

echo "$theme" > "$root_dir/var/st-theme"
echo -e "\n${GREEN}Installed theme!${NC}\n"
